# Vulnerability Remediation Guide

Comprehensive remediation strategies for common security vulnerabilities detected by security scans.

## Table of Contents
- [Secret Detection Remediation](#secret-detection-remediation)
- [Dependency Vulnerabilities](#dependency-vulnerabilities)
- [OWASP Top 10 Remediation](#owasp-top-10-remediation)
- [Security Header Configuration](#security-header-configuration)

---

## Secret Detection Remediation

### Exposed API Keys

**Problem:** Hardcoded API keys found in source code

**Immediate Actions:**
1. **Rotate the exposed key immediately** - Assume it's compromised
2. Remove from version control history using tools like `git-filter-repo` or `BFG Repo-Cleaner`
3. Update CI/CD and deployment scripts

**Long-term Fix:**
```javascript
// Bad - Hardcoded
const apiKey = "AKIAIOSFODNN7EXAMPLE";

// Good - Environment variable
const apiKey = process.env.API_KEY;
```

**Best Practices:**
- Store secrets in environment variables
- Use secrets management services (AWS Secrets Manager, HashiCorp Vault, Azure Key Vault)
- Add `.env` to `.gitignore`
- Use `.env.example` for documentation (with placeholder values)
- Implement pre-commit hooks to prevent accidental commits

### Hardcoded Passwords

**Problem:** Passwords hardcoded in configuration files

**Immediate Actions:**
1. Change password immediately
2. Audit access logs for unauthorized access
3. Remove from codebase and history

**Long-term Fix:**
```python
# Bad
db_password = "MySecretPassword123"

# Good
import os
db_password = os.getenv("DB_PASSWORD")

# Even better - use connection string from environment
DATABASE_URL = os.getenv("DATABASE_URL")
```

### Private Keys in Repository

**Problem:** RSA/SSH private keys committed to repository

**Immediate Actions:**
1. **Generate new key pair immediately**
2. Update authorized_keys on all servers
3. Revoke old public key from all systems
4. Remove from git history completely

**Prevention:**
```bash
# Add to .gitignore
*.key
*.pem
*.p12
*.pfx
id_rsa
id_dsa
id_ed25519
```

---

## Dependency Vulnerabilities

### Critical Vulnerability in npm Package

**Problem:** Critical CVE in a direct dependency

**Immediate Actions:**
1. Check if vulnerability is exploitable in your context
2. Upgrade to patched version: `npm update <package>`
3. If no patch available, find alternative package or vendor patch

**Example Workflow:**
```bash
# Check vulnerability details
npm audit

# Update specific package
npm update lodash --save

# If major version change required
npm install lodash@latest --save

# Verify fix
npm audit
```

**If No Fix Available:**
- Check for security advisories and workarounds
- Implement compensating controls
- Consider forking and patching yourself
- Replace with alternative package
- Add to audit exceptions (with justification)

### Transitive Dependency Vulnerability

**Problem:** Vulnerability in package dependency (not direct)

**Resolution:**
```bash
# View dependency tree
npm ls <vulnerable-package>

# Force resolution (npm)
npm install <parent-package>@latest

# Use overrides in package.json (npm 8.3+)
{
  "overrides": {
    "vulnerable-package": "^2.0.0"
  }
}

# Use resolutions in package.json (yarn)
{
  "resolutions": {
    "vulnerable-package": "^2.0.0"
  }
}
```

### Python Dependency Vulnerability

**Problem:** Vulnerable Python package

**Resolution:**
```bash
# Scan for vulnerabilities
pip-audit

# Upgrade specific package
pip install --upgrade requests

# Update requirements.txt
pip freeze > requirements.txt

# For safety tool
safety check
safety check --json
```

---

## OWASP Top 10 Remediation

### A01: Broken Access Control

#### Missing Authorization Checks

**Problem:** Direct object reference without authorization check

**Vulnerable Code:**
```javascript
app.get('/api/users/:id', async (req, res) => {
  const user = await User.findById(req.params.id);
  res.json(user); // Anyone can access any user!
});
```

**Fixed Code:**
```javascript
app.get('/api/users/:id', authenticateUser, async (req, res) => {
  const requestedUserId = req.params.id;
  const currentUserId = req.user.id;

  // Only allow users to access their own data
  if (requestedUserId !== currentUserId && !req.user.isAdmin) {
    return res.status(403).json({ error: 'Forbidden' });
  }

  const user = await User.findById(requestedUserId);
  res.json(user);
});
```

### A02: Cryptographic Failures

#### Weak Password Hashing

**Problem:** Using MD5 or SHA1 for password hashing

**Vulnerable Code:**
```javascript
const crypto = require('crypto');
const hash = crypto.createHash('md5').update(password).digest('hex');
```

**Fixed Code:**
```javascript
const bcrypt = require('bcrypt');
const saltRounds = 12;

// Hashing
const hash = await bcrypt.hash(password, saltRounds);

// Verification
const isValid = await bcrypt.compare(password, hash);
```

#### HTTP Instead of HTTPS

**Problem:** Sensitive data transmitted over HTTP

**Fix:**
```nginx
# Nginx - Redirect HTTP to HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name example.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
}
```

### A03: Injection

#### SQL Injection

**Problem:** String concatenation in SQL queries

**Vulnerable Code:**
```javascript
const query = `SELECT * FROM users WHERE username = '${username}' AND password = '${password}'`;
db.query(query);
```

**Fixed Code:**
```javascript
// Using parameterized query
const query = 'SELECT * FROM users WHERE username = ? AND password = ?';
db.query(query, [username, passwordHash]);

// Using ORM (Sequelize)
const user = await User.findOne({
  where: { username, password: passwordHash }
});
```

#### Command Injection

**Problem:** Unsanitized user input in shell command

**Vulnerable Code:**
```javascript
const exec = require('child_process').exec;
exec(`ping -c 4 ${userInput}`, callback); // Dangerous!
```

**Fixed Code:**
```javascript
const { spawn } = require('child_process');
// Use spawn with explicit arguments (no shell interpretation)
const ping = spawn('ping', ['-c', '4', userInput]);

// Or validate against allowlist
const validHosts = ['google.com', 'github.com'];
if (!validHosts.includes(userInput)) {
  throw new Error('Invalid host');
}
```

### A04: Insecure Design

#### Missing Rate Limiting

**Problem:** No rate limiting on authentication endpoint

**Fix:**
```javascript
const rateLimit = require('express-rate-limit');

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 5, // Limit each IP to 5 requests per windowMs
  message: 'Too many login attempts, please try again later',
  standardHeaders: true,
  legacyHeaders: false,
});

app.post('/api/login', loginLimiter, async (req, res) => {
  // Login logic
});
```

### A05: Security Misconfiguration

#### Debug Mode Enabled in Production

**Problem:** Application running with debug mode

**Fix:**
```javascript
// Use environment-specific configuration
const isProduction = process.env.NODE_ENV === 'production';

const app = express();

if (!isProduction) {
  app.use(errorHandler()); // Detailed errors in dev only
} else {
  // Generic error handler for production
  app.use((err, req, res, next) => {
    console.error(err.stack); // Log but don't expose
    res.status(500).json({ error: 'Internal server error' });
  });
}
```

#### Default Credentials

**Problem:** Application using default admin/admin credentials

**Fix:**
1. Force password change on first login
2. Generate random credentials during setup
3. Require strong passwords
4. Document credential management in setup guide

### A07: Authentication Failures

#### Weak Password Policy

**Problem:** Accepting weak passwords

**Fix:**
```javascript
const passwordValidator = require('password-validator');

const schema = new passwordValidator();
schema
  .is().min(12)                                   // Minimum length 12
  .is().max(128)                                  // Maximum length 128
  .has().uppercase()                              // Must have uppercase
  .has().lowercase()                              // Must have lowercase
  .has().digits(2)                                // Must have at least 2 digits
  .has().not().spaces()                           // Should not have spaces
  .is().not().oneOf(['Password123', 'Admin123']); // Blacklist common

if (!schema.validate(password)) {
  throw new Error('Password does not meet requirements');
}
```

### A08: Software and Data Integrity Failures

#### Insecure Deserialization

**Problem:** Deserializing untrusted data

**Vulnerable Code (Python):**
```python
import pickle
user_data = pickle.loads(request.data)  # Dangerous!
```

**Fixed Code:**
```python
import json
user_data = json.loads(request.data)  # Safe

# Validate structure
from jsonschema import validate
schema = {
  "type": "object",
  "properties": {
    "username": {"type": "string"},
    "email": {"type": "string", "format": "email"}
  },
  "required": ["username", "email"]
}
validate(instance=user_data, schema=schema)
```

### A10: SSRF (Server-Side Request Forgery)

**Problem:** Unvalidated URL from user input

**Vulnerable Code:**
```javascript
app.post('/fetch', async (req, res) => {
  const url = req.body.url;
  const response = await fetch(url); // Dangerous!
  res.json(await response.json());
});
```

**Fixed Code:**
```javascript
const { URL } = require('url');

app.post('/fetch', async (req, res) => {
  const urlString = req.body.url;

  // Validate URL
  let url;
  try {
    url = new URL(urlString);
  } catch {
    return res.status(400).json({ error: 'Invalid URL' });
  }

  // Allowlist check
  const allowedHosts = ['api.example.com', 'cdn.example.com'];
  if (!allowedHosts.includes(url.hostname)) {
    return res.status(403).json({ error: 'Host not allowed' });
  }

  // Scheme check
  if (url.protocol !== 'https:') {
    return res.status(403).json({ error: 'Only HTTPS allowed' });
  }

  // Block private IP ranges
  const privateIPRanges = [
    /^10\./,
    /^172\.(1[6-9]|2[0-9]|3[01])\./,
    /^192\.168\./,
    /^127\./,
    /^169\.254\./
  ];

  if (privateIPRanges.some(range => range.test(url.hostname))) {
    return res.status(403).json({ error: 'Private IPs not allowed' });
  }

  const response = await fetch(url.href);
  res.json(await response.json());
});
```

---

## Security Header Configuration

### Missing Content-Security-Policy

**Problem:** XSS attacks possible due to missing CSP

**Fix (Express.js):**
```javascript
const helmet = require('helmet');

app.use(
  helmet.contentSecurityPolicy({
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'"],
      fontSrc: ["'self'"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      frameSrc: ["'none'"],
    },
  })
);
```

### Missing HSTS

**Problem:** Vulnerable to SSL stripping attacks

**Fix (Nginx):**
```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
```

**Fix (Express.js):**
```javascript
app.use(helmet.hsts({
  maxAge: 31536000,
  includeSubDomains: true,
  preload: true
}));
```

---

## General Remediation Best Practices

### 1. Prioritization

**Severity Order:**
1. Critical - Fix within 24 hours
2. High - Fix within 1 week
3. Medium - Fix within 1 month
4. Low - Fix in next sprint

### 2. Verification

After remediation:
```bash
# Re-run all scans
bash scripts/scan-secrets.sh ./project
bash scripts/scan-dependencies.sh ./project
bash scripts/scan-owasp.sh ./project
bash scripts/check-security-headers.sh https://example.com

# Generate new report
bash scripts/generate-security-report.sh ./scan-results
```

### 3. Documentation

Document all remediations:
- Vulnerability found
- Date discovered
- Remediation applied
- Verification method
- Re-scan results

### 4. Prevention

Prevent recurrence:
- Add to CI/CD pipeline
- Update security checklist
- Team training
- Pre-commit hooks
- Regular security reviews

---

**Last Updated:** 2025-10-29
**Version:** 1.0
