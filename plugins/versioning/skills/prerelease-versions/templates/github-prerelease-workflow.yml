name: Pre-release Management

on:
  push:
    branches:
      - 'alpha/**'
      - 'beta/**'
      - 'release/**'
    tags:
      - 'v*.*.*-alpha.*'
      - 'v*.*.*-beta.*'
      - 'v*.*.*-rc.*'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  detect-prerelease-type:
    name: Detect Pre-release Type
    runs-on: ubuntu-latest
    outputs:
      prerelease_type: ${{ steps.detect.outputs.type }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect pre-release type from branch or tag
        id: detect
        run: |
          if [[ "${{ github.ref }}" =~ ^refs/heads/alpha/ ]]; then
            echo "type=alpha" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/heads/beta/ ]]; then
            echo "type=beta" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release/ ]]; then
            echo "type=rc" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v.*-alpha\. ]]; then
            echo "type=alpha" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v.*-beta\. ]]; then
            echo "type=beta" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v.*-rc\. ]]; then
            echo "type=rc" >> $GITHUB_OUTPUT
          else
            echo "type=unknown" >> $GITHUB_OUTPUT
          fi

          # Extract version from VERSION file or package.json
          if [ -f VERSION ]; then
            if grep -q "{" VERSION; then
              VERSION=$(jq -r '.version' VERSION)
            else
              VERSION=$(cat VERSION)
            fi
          elif [ -f package.json ]; then
            VERSION=$(jq -r '.version' package.json)
          else
            VERSION="unknown"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  validate-prerelease:
    name: Validate Pre-release
    needs: detect-prerelease-type
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run pre-release validation
        run: |
          bash plugins/versioning/skills/prerelease-versions/scripts/test-prerelease.sh \
            ${{ needs.detect-prerelease-type.outputs.version }}

  test-alpha:
    name: Alpha Testing
    needs: [detect-prerelease-type, validate-prerelease]
    if: needs.detect-prerelease-type.outputs.prerelease_type == 'alpha'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Set up Python ${{ matrix.python-version }}
        if: hashFiles('pyproject.toml') != ''
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies (Node.js)
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Install dependencies (Python)
        if: hashFiles('pyproject.toml') != ''
        run: |
          pip install poetry
          poetry install

      - name: Run unit tests
        run: |
          if [ -f package.json ]; then
            npm test
          elif [ -f pyproject.toml ]; then
            poetry run pytest
          fi

      - name: Run integration tests
        run: |
          if [ -f package.json ] && [ -f "package.json" ] && grep -q "test:integration" package.json; then
            npm run test:integration
          fi

  test-beta:
    name: Beta Testing
    needs: [detect-prerelease-type, validate-prerelease]
    if: needs.detect-prerelease-type.outputs.prerelease_type == 'beta'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          if [ -f package.json ]; then
            npm ci
          elif [ -f pyproject.toml ]; then
            pip install poetry
            poetry install
          fi

      - name: Run unit tests
        run: |
          if [ -f package.json ]; then
            npm test
          elif [ -f pyproject.toml ]; then
            poetry run pytest
          fi

      - name: Run integration tests
        run: |
          if [ -f package.json ] && grep -q "test:integration" package.json; then
            npm run test:integration
          fi

      - name: Run E2E tests
        run: |
          if [ -f package.json ] && grep -q "test:e2e" package.json; then
            npm run test:e2e
          fi

      - name: Performance testing
        run: |
          if [ -f package.json ] && grep -q "test:performance" package.json; then
            npm run test:performance
          fi

  test-rc:
    name: Release Candidate Testing
    needs: [detect-prerelease-type, validate-prerelease]
    if: needs.detect-prerelease-type.outputs.prerelease_type == 'rc'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          if [ -f package.json ]; then
            npm ci
          elif [ -f pyproject.toml ]; then
            pip install poetry
            poetry install
          fi

      - name: Run full test suite
        run: |
          if [ -f package.json ]; then
            npm test
            npm run test:integration || true
            npm run test:e2e || true
          elif [ -f pyproject.toml ]; then
            poetry run pytest --cov
          fi

      - name: Security audit
        run: |
          if [ -f package.json ]; then
            npm audit --production
          elif [ -f pyproject.toml ]; then
            pip install safety
            safety check
          fi

      - name: Build verification
        run: |
          if [ -f package.json ] && grep -q "build" package.json; then
            npm run build
          fi

  create-github-prerelease:
    name: Create GitHub Pre-release
    needs: [detect-prerelease-type, validate-prerelease]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "${{ steps.version.outputs.version }}" | head -n 1)

          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Pre-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Pre-release v${{ steps.version.outputs.version }}
          body: |
            # Pre-release ${{ steps.version.outputs.version }}

            **Type**: ${{ needs.detect-prerelease-type.outputs.prerelease_type }}

            ## Changes

            ${{ steps.changelog.outputs.changelog }}

            ## Installation

            ### npm
            ```bash
            npm install your-package@${{ steps.version.outputs.version }}
            ```

            ### pip
            ```bash
            pip install your-package==${{ steps.version.outputs.version }}
            ```

            ---

            ‚ö†Ô∏è This is a pre-release version. Use with caution in production.
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Send Notifications
    needs: [detect-prerelease-type, validate-prerelease]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          TYPE="${{ needs.detect-prerelease-type.outputs.prerelease_type }}"
          VERSION="${{ needs.detect-prerelease-type.outputs.version }}"

          if [ "$TYPE" = "alpha" ]; then
            EMOJI="üöß"
            CHANNEL="#dev-alpha"
          elif [ "$TYPE" = "beta" ]; then
            EMOJI="üß™"
            CHANNEL="#qa-beta"
          elif [ "$TYPE" = "rc" ]; then
            EMOJI="‚úÖ"
            CHANNEL="#releases"
          fi

          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d "{
              \"channel\": \"${CHANNEL}\",
              \"text\": \"${EMOJI} Pre-release ${VERSION} (${TYPE}) is ready for testing\",
              \"username\": \"Release Bot\"
            }"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
