name: Test Doppler Secrets

# This workflow tests that Doppler secrets are properly synced to GitHub
# Run manually after setting up Doppler GitHub integration

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      environment:
        description: 'Environment to test'
        required: false
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  test-secrets:
    name: Test ${{ github.event.inputs.environment || 'development' }} Secrets
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify Doppler secrets are loaded
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Testing Doppler Secret Sync"
          echo "Environment: ${{ github.event.inputs.environment || 'development' }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          # Check if secrets exist (without exposing values)
          echo "Checking secrets..."
          echo ""

          # Application Settings
          if [ -n "${{ secrets.ENVIRONMENT }}" ]; then
            echo "✓ ENVIRONMENT = ${{ secrets.ENVIRONMENT }}"
          else
            echo "✗ ENVIRONMENT is missing"
            exit 1
          fi

          if [ -n "${{ secrets.PORT }}" ]; then
            echo "✓ PORT = ${{ secrets.PORT }}"
          else
            echo "✗ PORT is missing"
            exit 1
          fi

          if [ -n "${{ secrets.DEBUG }}" ]; then
            echo "✓ DEBUG = ${{ secrets.DEBUG }}"
          else
            echo "✗ DEBUG is missing"
            exit 1
          fi

          # Google APIs
          if [ -n "${{ secrets.GOOGLE_API_KEY }}" ]; then
            echo "✓ GOOGLE_API_KEY exists (${#{{ secrets.GOOGLE_API_KEY }}@} characters)"
          else
            echo "✗ GOOGLE_API_KEY is missing"
            exit 1
          fi

          if [ -n "${{ secrets.GOOGLE_FILE_SEARCH_STORE_ID }}" ]; then
            echo "✓ GOOGLE_FILE_SEARCH_STORE_ID exists"
          else
            echo "✗ GOOGLE_FILE_SEARCH_STORE_ID is missing"
            exit 1
          fi

          # Supabase
          if [ -n "${{ secrets.SUPABASE_URL }}" ]; then
            echo "✓ SUPABASE_URL = ${{ secrets.SUPABASE_URL }}"
          else
            echo "✗ SUPABASE_URL is missing"
            exit 1
          fi

          if [ -n "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "✓ SUPABASE_ANON_KEY exists"
          else
            echo "✗ SUPABASE_ANON_KEY is missing"
            exit 1
          fi

          if [ -n "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "✓ SUPABASE_SERVICE_KEY exists"
          else
            echo "✗ SUPABASE_SERVICE_KEY is missing"
            exit 1
          fi

          # Batch Processing
          if [ -n "${{ secrets.BATCH_API_MODEL }}" ]; then
            echo "✓ BATCH_API_MODEL = ${{ secrets.BATCH_API_MODEL }}"
          else
            echo "✗ BATCH_API_MODEL is missing"
            exit 1
          fi

          if [ -n "${{ secrets.BATCH_API_TEMPERATURE }}" ]; then
            echo "✓ BATCH_API_TEMPERATURE = ${{ secrets.BATCH_API_TEMPERATURE }}"
          else
            echo "✗ BATCH_API_TEMPERATURE is missing"
            exit 1
          fi

          if [ -n "${{ secrets.BATCH_API_POLL_INTERVAL }}" ]; then
            echo "✓ BATCH_API_POLL_INTERVAL = ${{ secrets.BATCH_API_POLL_INTERVAL }}"
          else
            echo "✗ BATCH_API_POLL_INTERVAL is missing"
            exit 1
          fi

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✓ All required secrets are present!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Test environment-specific values
        run: |
          echo ""
          echo "Environment-specific verification:"
          echo ""

          # Check environment matches
          if [ "${{ secrets.ENVIRONMENT }}" = "development" ]; then
            echo "✓ Development environment configured correctly"
          elif [ "${{ secrets.ENVIRONMENT }}" = "staging" ]; then
            echo "✓ Staging environment configured correctly"
          elif [ "${{ secrets.ENVIRONMENT }}" = "production" ]; then
            echo "✓ Production environment configured correctly"
          else
            echo "⚠ Unexpected ENVIRONMENT value: ${{ secrets.ENVIRONMENT }}"
          fi

          # Check DEBUG flag
          if [ "${{ secrets.DEBUG }}" = "true" ]; then
            echo "✓ Debug mode: ENABLED"
          else
            echo "✓ Debug mode: DISABLED"
          fi

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "SUCCESS: Doppler → GitHub sync verified!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "✓ Doppler GitHub integration is working"
          echo "✓ All secrets synced successfully"
          echo "✓ Ready to use in deployment workflows"
          echo ""
          echo "Next steps:"
          echo "  1. Update deployment workflows to use these secrets"
          echo "  2. Test with actual deployment"
          echo "  3. Enable production protection rules"

  test-all-environments:
    name: Test All Environments
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == ''
    strategy:
      matrix:
        environment: [development, staging, production]
    environment: ${{ matrix.environment }}

    steps:
      - name: Verify ${{ matrix.environment }} secrets
        run: |
          echo "Testing ${{ matrix.environment }} environment..."

          if [ -n "${{ secrets.GOOGLE_API_KEY }}" ] && \
             [ -n "${{ secrets.SUPABASE_URL }}" ] && \
             [ -n "${{ secrets.ENVIRONMENT }}" ]; then
            echo "✓ ${{ matrix.environment }}: All critical secrets present"
          else
            echo "✗ ${{ matrix.environment }}: Missing secrets"
            exit 1
          fi
